@page "/"
@using Soft1_To_Atum.Blazor.Services
@using Soft1_To_Atum.Data.Models
@rendermode InteractiveServer

<PageTitle>SoftOne to ATUM Sync Dashboard</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">

    <MudText Typo="Typo.h3" GutterBottom="true">
        <MudIcon Icon="Icons.Material.Filled.Dashboard" Class="mr-3" />
        SoftOne to ATUM Sync Dashboard
    </MudText>

    <MudGrid>
        <!-- Sync Controls Card -->
        <MudItem xs="12" md="6">
            <MudCard>
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">
                            <MudIcon Icon="Icons.Material.Filled.Sync" Class="mr-2" />
                            Sync Controls
                        </MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    <MudText Typo="Typo.body2" GutterBottom="true">
                        Manually trigger synchronization between SoftOne Go and WooCommerce ATUM
                    </MudText>

                    <MudGrid Class="mt-3">
                        <MudItem xs="12" sm="6" md="3">
                            <MudButton Variant="Variant.Filled"
                                      Color="Color.Primary"
                                      Size="Size.Large"
                                      StartIcon="@Icons.Material.Filled.PlayArrow"
                                      OnClick="@StartManualSync"
                                      Disabled="@isSyncRunning"
                                      FullWidth="true">
                                @if (isSyncRunning)
                                {
                                    <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                                    <MudText Class="ms-2" Style="color: white;">Running SoftOne Sync...</MudText>
                                }
                                else
                                {
                                    <MudText Style="color: white;">SoftOne</MudText>
                                }
                            </MudButton>
                        </MudItem>
                        <MudItem xs="12" sm="6" md="3">
                            <MudButton Variant="Variant.Filled"
                                      Color="Color.Success"
                                      Size="Size.Large"
                                      StartIcon="@Icons.Material.Filled.Storefront"
                                      OnClick="@StartWooCommerceSync"
                                      Disabled="@isWooCommerceSyncRunning"
                                      FullWidth="true">
                                @if (isWooCommerceSyncRunning)
                                {
                                    <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                                    <MudText Class="ms-2" Style="color: white;">Running...</MudText>
                                }
                                else
                                {
                                    <MudText Style="color: white;">panes.gr</MudText>
                                }
                            </MudButton>
                        </MudItem>
                        <MudItem xs="12" sm="6" md="3">
                            <MudButton Variant="Variant.Filled"
                                      Color="Color.Info"
                                      Size="Size.Large"
                                      StartIcon="@Icons.Material.Filled.Inventory"
                                      OnClick="@StartAtumSync"
                                      Disabled="@isAtumSyncRunning"
                                      FullWidth="true">
                                @if (isAtumSyncRunning)
                                {
                                    <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                                    <MudText Class="ms-2">Running ATUM Sync...</MudText>
                                }
                                else
                                {
                                    <MudText Style="color: white;">ATUM</MudText>
                                }
                            </MudButton>
                        </MudItem>
                        <MudItem xs="12" sm="6" md="3">
                            <MudButton Variant="Variant.Filled"
                                      Color="Color.Secondary"
                                      Size="Size.Large"
                                      StartIcon="@Icons.Material.Filled.BatchPrediction"
                                      OnClick="@StartAtumBatchSync"
                                      Disabled="@isAtumBatchSyncRunning"
                                      FullWidth="true">
                                @if (isAtumBatchSyncRunning)
                                {
                                    <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                                    <MudText Class="ms-2">Running ATUM Batch...</MudText>
                                }
                                else
                                {
                                    <MudText Style="color: white;">Sync</MudText>
                                }
                            </MudButton>
                        </MudItem>
                    </MudGrid>

                    @if (!string.IsNullOrEmpty(lastSyncMessage))
                    {
                        <MudAlert Severity="@lastSyncSeverity" Class="mt-3">
                            @lastSyncMessage
                        </MudAlert>
                    }

                    @if (isWooCommerceSyncRunning && currentPage > 0)
                    {
                        <MudCard Class="mt-3">
                            <MudCardContent>
                                <MudText Typo="Typo.body2" GutterBottom="true">
                                    <strong>Page-by-Page Progress:</strong>
                                </MudText>
                                <MudGrid>
                                    <MudItem xs="6" sm="3">
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">Current Page</MudText>
                                        <MudText Typo="Typo.body1"><strong>@currentPage</strong></MudText>
                                    </MudItem>
                                    <MudItem xs="6" sm="3">
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">Total Fetched</MudText>
                                        <MudText Typo="Typo.body1"><strong>@totalFetched</strong></MudText>
                                    </MudItem>
                                    <MudItem xs="6" sm="3">
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">Created</MudText>
                                        <MudText Typo="Typo.body1" Color="Color.Success"><strong>@totalCreated</strong></MudText>
                                    </MudItem>
                                    <MudItem xs="6" sm="3">
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">Skipped</MudText>
                                        <MudText Typo="Typo.body1" Color="Color.Warning"><strong>@totalSkipped</strong></MudText>
                                    </MudItem>
                                </MudGrid>
                                <MudButton Variant="Variant.Outlined"
                                          Color="Color.Error"
                                          Size="Size.Small"
                                          StartIcon="@Icons.Material.Filled.Cancel"
                                          OnClick="@CancelWooCommerceSync"
                                          Class="mt-3">
                                    Cancel Sync
                                </MudButton>
                            </MudCardContent>
                        </MudCard>
                    }
                </MudCardContent>
            </MudCard>
        </MudItem>

        <!-- Sync Status Card -->
        <MudItem xs="12" md="6">
            <MudCard>
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">
                            <MudIcon Icon="Icons.Material.Filled.Timeline" Class="mr-2" />
                            Sync Status
                        </MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    @if (lastSyncLog != null)
                    {
                        <MudGrid>
                            <MudItem xs="6">
                                <MudText Typo="Typo.body2" Color="Color.Secondary">Last Sync:</MudText>
                                <MudText Typo="Typo.body1">@lastSyncLog.StartedAt.ToString("yyyy-MM-dd HH:mm")</MudText>
                            </MudItem>
                            <MudItem xs="6">
                                <MudText Typo="Typo.body2" Color="Color.Secondary">Status:</MudText>
                                <MudChip T="string" Color="@GetStatusColor(lastSyncLog.Status)" Size="Size.Small">
                                    @lastSyncLog.Status
                                </MudChip>
                            </MudItem>
                            <MudItem xs="6">
                                <MudText Typo="Typo.body2" Color="Color.Secondary">Duration:</MudText>
                                <MudText Typo="Typo.body1">@GetDurationString(lastSyncLog)</MudText>
                            </MudItem>
                            <MudItem xs="6">
                                <MudText Typo="Typo.body2" Color="Color.Secondary">Products:</MudText>
                                <MudText Typo="Typo.body1">@lastSyncLog.TotalProducts</MudText>
                            </MudItem>
                        </MudGrid>
                    }
                    else
                    {
                        <MudText Typo="Typo.body2" Color="Color.Secondary">No sync history available</MudText>
                    }
                </MudCardContent>
            </MudCard>
        </MudItem>

        <!-- Source-based Statistics Card -->
        <MudItem xs="12" md="6">
            <MudCard>
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">
                            <MudIcon Icon="Icons.Material.Filled.Analytics" Class="mr-2" />
                            Products by Source
                        </MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    @if (productStatistics != null)
                    {
                        <MudGrid>
                            <MudItem xs="12" Class="mb-3">
                                <MudPaper Class="pa-3 text-center" Style="background-color: var(--mud-palette-primary);">
                                    <MudText Typo="Typo.h3" Color="Color.Surface">@productStatistics.Total</MudText>
                                    <MudText Typo="Typo.body1" Color="Color.Surface">Total Products</MudText>
                                </MudPaper>
                            </MudItem>
                            <MudItem xs="4">
                                <MudPaper Class="pa-3 text-center" Style="background-color: var(--mud-palette-success);">
                                    <MudText Typo="Typo.h4" Color="Color.Surface">@productStatistics.BySources.SoftOne</MudText>
                                    <MudText Typo="Typo.body2" Color="Color.Surface">SoftOne</MudText>
                                </MudPaper>
                            </MudItem>
                            <MudItem xs="4">
                                <MudPaper Class="pa-3 text-center" Style="background-color: var(--mud-palette-info);">
                                    <MudText Typo="Typo.h4" Color="Color.Surface">@productStatistics.BySources.ATUM</MudText>
                                    <MudText Typo="Typo.body2" Color="Color.Surface">ATUM</MudText>
                                </MudPaper>
                            </MudItem>
                            <MudItem xs="4">
                                <MudPaper Class="pa-3 text-center" Style="background-color: var(--mud-palette-tertiary);">
                                    <MudText Typo="Typo.h4" Color="Color.Surface">@productStatistics.BySources.WooCommerce</MudText>
                                    <MudText Typo="Typo.body2" Color="Color.Surface">WooCommerce</MudText>
                                </MudPaper>
                            </MudItem>
                        </MudGrid>
                    }
                    else
                    {
                        <MudText Typo="Typo.body2" Color="Color.Secondary">No source statistics available</MudText>
                    }
                </MudCardContent>
            </MudCard>
        </MudItem>

        <!-- Sync Status Statistics Card -->
        <MudItem xs="12" md="6">
            <MudCard>
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">
                            <MudIcon Icon="Icons.Material.Filled.BarChart" Class="mr-2" />
                            Recent Sync Statistics
                        </MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    @if (lastSyncLog != null)
                    {
                        <MudGrid>
                            <MudItem xs="6" sm="6">
                                <MudPaper Class="pa-3 text-center" Style="background-color: var(--mud-palette-success);">
                                    <MudText Typo="Typo.h4" Color="Color.Surface">@lastSyncLog.CreatedProducts</MudText>
                                    <MudText Typo="Typo.body2" Color="Color.Surface">Created</MudText>
                                </MudPaper>
                            </MudItem>
                            <MudItem xs="6" sm="6">
                                <MudPaper Class="pa-3 text-center" Style="background-color: var(--mud-palette-info);">
                                    <MudText Typo="Typo.h4" Color="Color.Surface">@lastSyncLog.UpdatedProducts</MudText>
                                    <MudText Typo="Typo.body2" Color="Color.Surface">Updated</MudText>
                                </MudPaper>
                            </MudItem>
                            <MudItem xs="6" sm="6">
                                <MudPaper Class="pa-3 text-center" Style="background-color: var(--mud-palette-warning);">
                                    <MudText Typo="Typo.h4" Color="Color.Surface">@lastSyncLog.SkippedProducts</MudText>
                                    <MudText Typo="Typo.body2" Color="Color.Surface">Skipped</MudText>
                                </MudPaper>
                            </MudItem>
                            <MudItem xs="6" sm="6">
                                <MudPaper Class="pa-3 text-center" Style="background-color: var(--mud-palette-error);">
                                    <MudText Typo="Typo.h4" Color="Color.Surface">@lastSyncLog.ErrorCount</MudText>
                                    <MudText Typo="Typo.body2" Color="Color.Surface">Errors</MudText>
                                </MudPaper>
                            </MudItem>
                        </MudGrid>
                    }
                    else
                    {
                        <MudText Typo="Typo.body2" Color="Color.Secondary">No sync statistics available</MudText>
                    }
                </MudCardContent>
            </MudCard>
        </MudItem>

        <!-- Integration Statistics Card -->
        <MudItem xs="12">
            <MudCard>
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">
                            <MudIcon Icon="Icons.Material.Filled.Hub" Class="mr-2" />
                            Integration Statistics
                        </MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    @if (productStatistics != null)
                    {
                        <MudGrid>
                            <MudItem xs="6" sm="3">
                                <MudPaper Class="pa-3 text-center" Style="background-color: var(--mud-palette-secondary);">
                                    <MudText Typo="Typo.h4" Color="Color.Surface">@productStatistics.Integration.SoftOneAndATUM</MudText>
                                    <MudText Typo="Typo.body2" Color="Color.Surface">SoftOne + ATUM</MudText>
                                </MudPaper>
                            </MudItem>
                            <MudItem xs="6" sm="3">
                                <MudPaper Class="pa-3 text-center" Style="background-color: var(--mud-palette-secondary);">
                                    <MudText Typo="Typo.h4" Color="Color.Surface">@productStatistics.Integration.SoftOneAndWooCommerce</MudText>
                                    <MudText Typo="Typo.body2" Color="Color.Surface">SoftOne + WooCommerce</MudText>
                                </MudPaper>
                            </MudItem>
                            <MudItem xs="6" sm="3">
                                <MudPaper Class="pa-3 text-center" Style="background-color: var(--mud-palette-secondary);">
                                    <MudText Typo="Typo.h4" Color="Color.Surface">@productStatistics.Integration.ATUMAndWooCommerce</MudText>
                                    <MudText Typo="Typo.body2" Color="Color.Surface">ATUM + WooCommerce</MudText>
                                </MudPaper>
                            </MudItem>
                            <MudItem xs="6" sm="3">
                                <MudPaper Class="pa-3 text-center" Style="background-color: var(--mud-palette-dark);">
                                    <MudText Typo="Typo.h4" Color="Color.Surface">@productStatistics.Integration.AllThreeSources</MudText>
                                    <MudText Typo="Typo.body2" Color="Color.Surface">All Three Sources</MudText>
                                </MudPaper>
                            </MudItem>
                        </MudGrid>
                    }
                    else
                    {
                        <MudText Typo="Typo.body2" Color="Color.Secondary">No integration statistics available</MudText>
                    }
                </MudCardContent>
            </MudCard>
        </MudItem>

        <!-- Quick Actions -->
        <MudItem xs="12">
            <MudCard>
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">
                            <MudIcon Icon="Icons.Material.Filled.Speed" Class="mr-2" />
                            Quick Actions
                        </MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    <MudGrid>
                        <MudItem xs="12" sm="6" md="3">
                            <MudButton Variant="Variant.Outlined"
                                      Color="Color.Primary"
                                      StartIcon="@Icons.Material.Filled.Settings"
                                      Href="/settings"
                                      FullWidth="true">
                                Configure Settings
                            </MudButton>
                        </MudItem>
                        <MudItem xs="12" sm="6" md="3">
                            <MudButton Variant="Variant.Outlined"
                                      Color="Color.Secondary"
                                      StartIcon="@Icons.Material.Filled.History"
                                      OnClick="@LoadSyncHistory"
                                      FullWidth="true">
                                View Sync History
                            </MudButton>
                        </MudItem>
                        <MudItem xs="12" sm="6" md="3">
                            <MudButton Variant="Variant.Outlined"
                                      Color="Color.Info"
                                      StartIcon="@Icons.Material.Filled.CheckCircle"
                                      OnClick="@TestConnections"
                                      FullWidth="true">
                                Test Connections
                            </MudButton>
                        </MudItem>
                        <MudItem xs="12" sm="6" md="3">
                            <MudButton Variant="Variant.Outlined"
                                      Color="Color.Tertiary"
                                      StartIcon="@Icons.Material.Filled.Refresh"
                                      OnClick="@RefreshDashboard"
                                      FullWidth="true">
                                Refresh Dashboard
                            </MudButton>
                        </MudItem>
                    </MudGrid>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>
</MudContainer>
