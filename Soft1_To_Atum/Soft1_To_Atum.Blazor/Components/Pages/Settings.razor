@page "/settings"
@rendermode InteractiveServer
@using Soft1_To_Atum.Data.Models

<PageTitle>Settings - SoftOne to ATUM Sync</PageTitle>

<MudText Typo="Typo.h3" Class="mb-4">Settings</MudText>
<MudText Typo="Typo.body1" Class="mb-6" Color="Color.Secondary">
    Configure synchronization settings and API credentials for SoftOne Go, WooCommerce and ATUM
</MudText>

@if (globalSettings == null || storeSettings == null)
{
    <div class="d-flex justify-center align-center" style="height: 200px;">
        <MudProgressCircular Indeterminate="true" Size="Size.Large" Color="Color.Primary" />
        <MudText Typo="Typo.h6" Class="ml-4">Loading settings...</MudText>
    </div>
}
else
{
    <MudGrid>
        <!-- No Stores Warning -->
        @if (stores != null && stores.Count == 0)
        {
            <MudItem xs="12">
                <MudAlert Severity="Severity.Warning" Variant="Variant.Filled" Class="mb-4">
                    <MudText Typo="Typo.h6" Class="mb-2">No Stores Configured</MudText>
                    <MudText Typo="Typo.body2">You need to create at least one store before you can configure store-specific settings.</MudText>
                    <MudButton Href="/stores" Color="Color.Dark" Variant="Variant.Text" StartIcon="@Icons.Material.Filled.Store" Class="mt-2">
                        Go to Stores Management
                    </MudButton>
                </MudAlert>
            </MudItem>
        }

        <!-- Store Selection -->
        @if (stores != null && stores.Count > 1)
        {
            <MudItem xs="12">
                <MudPaper Class="pa-6 mb-4">
                    <MudSelect T="int" Value="selectedStoreId"
                             Label="Select Store"
                             Variant="Variant.Outlined"
                             ValueChanged="OnStoreChanged">
                        @foreach (var store in stores)
                        {
                            <MudSelectItem T="int" Value="@store.Id">@store.Name</MudSelectItem>
                        }
                    </MudSelect>
                </MudPaper>
            </MudItem>
        }

        <!-- Store Information -->
        <MudItem xs="12">
            <MudPaper Class="pa-6 mb-4">
                <MudText Typo="Typo.h5" Class="mb-4">
                    <MudIcon Icon="@Icons.Material.Filled.Store" Class="mr-2" />
                    Store Information
                </MudText>
                <MudGrid>
                    <MudItem xs="12" md="8">
                        <MudTextField @bind-Value="storeSettings.Name"
                                    Label="Store Name"
                                    Variant="Variant.Outlined"
                                    HelperText="Display name for this store" />
                    </MudItem>
                    <MudItem xs="12" md="4">
                        <MudSwitch @bind-Value="storeSettings.Enabled"
                                 Label="Store Enabled"
                                 Color="Color.Primary" />
                    </MudItem>
                </MudGrid>
            </MudPaper>
        </MudItem>

        <!-- SoftOne Go Settings -->
        <MudItem xs="12">
            <MudPaper Class="pa-6 mb-4">
                <MudText Typo="Typo.h5" Class="mb-4">
                    <MudIcon Icon="@Icons.Material.Filled.Business" Class="mr-2" />
                    SoftOne Go Settings
                </MudText>
                <MudGrid>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="storeSettings.SoftOneGo.BaseUrl"
                                    Label="Base URL"
                                    Variant="Variant.Outlined"
                                    HelperText="SoftOne Go API base URL" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="storeSettings.SoftOneGo.AppId"
                                    Label="App ID"
                                    Variant="Variant.Outlined"
                                    HelperText="Application ID in SoftOne Go" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="storeSettings.SoftOneGo.S1Code"
                                    Label="S1 Code"
                                    Variant="Variant.Outlined"
                                    HelperText="Company code in SoftOne" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="storeSettings.SoftOneGo.Token"
                                    Label="Token"
                                    InputType="InputType.Password"
                                    Variant="Variant.Outlined"
                                    HelperText="Authentication token" />
                    </MudItem>
                    <MudItem xs="12">
                        <MudTextField @bind-Value="storeSettings.SoftOneGo.Filters"
                                    Label="Filters"
                                    Variant="Variant.Outlined"
                                    Lines="2"
                                    HelperText="Query filters for product data (e.g., quantity ranges)" />
                    </MudItem>
                    <MudItem xs="12">
                        <MudButton StartIcon="@Icons.Material.Filled.CheckCircle"
                                 Color="Color.Secondary"
                                 Variant="Variant.Outlined"
                                 OnClick="@(() => TestConnection("softone"))"
                                 Disabled="isTestingConnection">
                            @if (isTestingConnection && testingService == "softone")
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                                <span class="ml-2">Testing...</span>
                            }
                            else
                            {
                                <span>Test Connection</span>
                            }
                        </MudButton>
                    </MudItem>
                </MudGrid>
            </MudPaper>
        </MudItem>

        <!-- WooCommerce Settings -->
        <MudItem xs="12">
            <MudPaper Class="pa-6 mb-4">
                <MudText Typo="Typo.h5" Class="mb-4">
                    <MudIcon Icon="@Icons.Material.Filled.ShoppingCart" Class="mr-2" />
                    WooCommerce Settings
                </MudText>
                <MudGrid>
                    <MudItem xs="12">
                        <MudTextField @bind-Value="globalSettings.WooCommerce.Url"
                                    Label="Store URL"
                                    Placeholder="https://your-store.com"
                                    Variant="Variant.Outlined"
                                    HelperText="Your WooCommerce store URL" />
                    </MudItem>
                    <MudItem xs="12" md="4">
                        <MudTextField @bind-Value="globalSettings.WooCommerce.Version"
                                    Label="API Version"
                                    Variant="Variant.Outlined"
                                    HelperText="WooCommerce API version" />
                    </MudItem>
                    <MudItem xs="12" md="4">
                        <MudTextField @bind-Value="globalSettings.WooCommerce.ConsumerKey"
                                    Label="Consumer Key"
                                    InputType="InputType.Password"
                                    Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" md="4">
                        <MudTextField @bind-Value="globalSettings.WooCommerce.ConsumerSecret"
                                    Label="Consumer Secret"
                                    InputType="InputType.Password"
                                    Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12">
                        <MudButton StartIcon="@Icons.Material.Filled.CheckCircle"
                                 Color="Color.Secondary"
                                 Variant="Variant.Outlined"
                                 OnClick="@(() => TestConnection("woocommerce"))"
                                 Disabled="isTestingConnection">
                            @if (isTestingConnection && testingService == "woocommerce")
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                                <span class="ml-2">Testing...</span>
                            }
                            else
                            {
                                <span>Test Connection</span>
                            }
                        </MudButton>
                    </MudItem>
                </MudGrid>
            </MudPaper>
        </MudItem>

        <!-- ATUM Settings -->
        <MudItem xs="12">
            <MudPaper Class="pa-6 mb-4">
                <MudText Typo="Typo.h5" Class="mb-4">
                    <MudIcon Icon="@Icons.Material.Filled.Inventory" Class="mr-2" />
                    ATUM Multi Inventory Settings
                </MudText>
                <MudGrid>
                    <MudItem xs="12" md="6">
                        <MudNumericField @bind-Value="storeSettings.ATUM.LocationId"
                                       Label="Location ID"
                                       Variant="Variant.Outlined"
                                       HelperText="ATUM inventory location ID" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="storeSettings.ATUM.LocationName"
                                    Label="Location Name"
                                    Variant="Variant.Outlined"
                                    HelperText="ATUM location identifier" />
                    </MudItem>
                </MudGrid>
            </MudPaper>
        </MudItem>

        <!-- Product Matching Settings -->
        <MudItem xs="12">
            <MudPaper Class="pa-6 mb-4">
                <MudText Typo="Typo.h5" Class="mb-4">
                    <MudIcon Icon="@Icons.Material.Filled.LinkOff" Class="mr-2" />
                    Product Matching Settings
                </MudText>
                <MudGrid>
                    <MudItem xs="12" md="6">
                        <MudSelect @bind-Value="globalSettings.Matching.PrimaryField"
                                 Label="Primary Matching Field"
                                 Variant="Variant.Outlined"
                                 HelperText="Primary field to match products">
                            <MudSelectItem Value="@("sku")">SKU</MudSelectItem>
                            <MudSelectItem Value="@("barcode")">Barcode</MudSelectItem>
                            <MudSelectItem Value="@("code")">Code</MudSelectItem>
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudSelect @bind-Value="globalSettings.Matching.SecondaryField"
                                 Label="Secondary Matching Field"
                                 Variant="Variant.Outlined"
                                 HelperText="Fallback field to match products">
                            <MudSelectItem Value="@("sku")">SKU</MudSelectItem>
                            <MudSelectItem Value="@("barcode")">Barcode</MudSelectItem>
                            <MudSelectItem Value="@("code")">Code</MudSelectItem>
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudSwitch @bind-Value="globalSettings.Matching.CreateMissingProducts"
                                 Label="Create Missing Products"
                                 Color="Color.Primary" />
                        <MudText Typo="Typo.caption" Class="ml-4">Create products that don't exist in WooCommerce</MudText>
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudSwitch @bind-Value="globalSettings.Matching.UpdateExistingProducts"
                                 Label="Update Existing Products"
                                 Color="Color.Primary" />
                        <MudText Typo="Typo.caption" Class="ml-4">Update products that already exist in WooCommerce</MudText>
                    </MudItem>
                </MudGrid>
            </MudPaper>
        </MudItem>

        <!-- Field Mapping Settings -->
        <MudItem xs="12">
            <MudPaper Class="pa-6 mb-4">
                <MudText Typo="Typo.h5" Class="mb-4">
                    <MudIcon Icon="@Icons.Material.Filled.Transform" Class="mr-2" />
                    Field Mapping (SoftOne Go → WooCommerce)
                </MudText>
                <MudGrid>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="globalSettings.FieldMapping.Sku"
                                    Label="SKU Field"
                                    Variant="Variant.Outlined"
                                    HelperText="SoftOne field for product SKU" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="globalSettings.FieldMapping.Name"
                                    Label="Name Field"
                                    Variant="Variant.Outlined"
                                    HelperText="SoftOne field for product name" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="globalSettings.FieldMapping.Price"
                                    Label="Price Field"
                                    Variant="Variant.Outlined"
                                    HelperText="SoftOne field for product price" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="globalSettings.FieldMapping.StockQuantity"
                                    Label="Stock Quantity Field"
                                    Variant="Variant.Outlined"
                                    HelperText="SoftOne field for stock quantity" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="globalSettings.FieldMapping.Category"
                                    Label="Category Field"
                                    Variant="Variant.Outlined"
                                    HelperText="SoftOne field for product category" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="globalSettings.FieldMapping.Unit"
                                    Label="Unit Field"
                                    Variant="Variant.Outlined"
                                    HelperText="SoftOne field for product unit" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="globalSettings.FieldMapping.Vat"
                                    Label="VAT Field"
                                    Variant="Variant.Outlined"
                                    HelperText="SoftOne field for VAT rate" />
                    </MudItem>
                </MudGrid>
            </MudPaper>
        </MudItem>

        <!-- Sync Settings -->
        <MudItem xs="12">
            <MudPaper Class="pa-6 mb-4">
                <MudText Typo="Typo.h5" Class="mb-4">
                    <MudIcon Icon="@Icons.Material.Filled.Sync" Class="mr-2" />
                    Sync Settings
                </MudText>
                <MudGrid>
                    <MudItem xs="12" md="4">
                        <MudNumericField @bind-Value="globalSettings.Sync.IntervalMinutes"
                                       Label="Sync Interval (minutes)"
                                       Variant="Variant.Outlined"
                                       Min="1"
                                       Max="1440"
                                       HelperText="How often to sync automatically" />
                    </MudItem>
                    <MudItem xs="12" md="4">
                        <MudSwitch @bind-Value="globalSettings.Sync.AutoSync"
                                 Label="Auto Sync Enabled"
                                 Color="Color.Primary" />
                    </MudItem>
                    <MudItem xs="12" md="4">
                        <MudSwitch @bind-Value="globalSettings.Sync.EmailNotifications"
                                 Label="Email Notifications"
                                 Color="Color.Primary" />
                    </MudItem>
                </MudGrid>
            </MudPaper>
        </MudItem>

        <!-- Email Settings -->
        <MudItem xs="12">
            <MudPaper Class="pa-6 mb-4">
                <MudText Typo="Typo.h5" Class="mb-4">
                    <MudIcon Icon="@Icons.Material.Filled.Email" Class="mr-2" />
                    Email Settings
                </MudText>
                <MudGrid>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="globalSettings.Email.SmtpHost"
                                    Label="SMTP Host"
                                    Placeholder="smtp.gmail.com"
                                    Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudNumericField @bind-Value="globalSettings.Email.SmtpPort"
                                       Label="SMTP Port"
                                       Variant="Variant.Outlined"
                                       Min="1"
                                       Max="65535" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="globalSettings.Email.Username"
                                    Label="Username"
                                    Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="globalSettings.Email.Password"
                                    Label="Password"
                                    InputType="InputType.Password"
                                    Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="globalSettings.Email.FromEmail"
                                    Label="From Email"
                                    Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="globalSettings.Email.ToEmail"
                                    Label="To Email"
                                    Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12">
                        <MudButton StartIcon="@Icons.Material.Filled.Email"
                                 Color="Color.Secondary"
                                 Variant="Variant.Outlined"
                                 OnClick="@(() => TestEmail())"
                                 Disabled="isTestingEmail">
                            @if (isTestingEmail)
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                                <span class="ml-2">Sending Test Email...</span>
                            }
                            else
                            {
                                <span>Send Test Email</span>
                            }
                        </MudButton>
                    </MudItem>
                </MudGrid>
            </MudPaper>
        </MudItem>

        <!-- Action Buttons -->
        <MudItem xs="12">
            <MudStack Row="true" Spacing="3" Justify="Justify.SpaceBetween">
                <MudButton StartIcon="@Icons.Material.Filled.Download"
                         Color="Color.Info"
                         Variant="Variant.Outlined"
                         OnClick="@ExportSettings"
                         Disabled="isExporting">
                    @if (isExporting)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                        <span class="ml-2">Exporting...</span>
                    }
                    else
                    {
                        <span>Export for Windows Service</span>
                    }
                </MudButton>
                <MudStack Row="true" Spacing="3">
                    @* <MudButton StartIcon="@Icons.Material.Filled.BugReport"
                             Color="Color.Info"
                             Variant="Variant.Text"
                             OnClick="@(async () => await TestApiConnection())"
                             Size="Size.Small">
                        Test API
                    </MudButton>
                    <MudButton StartIcon="@Icons.Material.Filled.Refresh"
                             Color="Color.Secondary"
                             Variant="Variant.Outlined"
                             OnClick="@(async () => await LoadSettings())"
                             Disabled="isSaving">
                        Reset
                    </MudButton> *@
                    <MudButton StartIcon="@Icons.Material.Filled.Save"
                             Color="Color.Primary"
                             Variant="Variant.Filled"
                             OnClick="@(async () => await SaveSettings())"
                             Disabled="isSaving">
                        @if (isSaving)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                            <span class="ml-2">Saving...</span>
                        }
                        else
                        {
                            <span>Save Settings</span>
                        }
                    </MudButton>
                </MudStack>
            </MudStack>
        </MudItem>
    </MudGrid>
}