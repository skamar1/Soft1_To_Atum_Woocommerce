@page "/global-settings"
@rendermode InteractiveServer
@using Soft1_To_Atum.Data.Models

<PageTitle>Global Settings - SoftOne to ATUM Sync</PageTitle>

<MudText Typo="Typo.h3" Class="mb-4">Global Settings</MudText>
<MudText Typo="Typo.body1" Class="mb-6" Color="Color.Secondary">
    Configure global settings shared across all stores (WooCommerce, Email, Sync, Matching, Field Mapping)
</MudText>

@if (settings == null)
{
    <div class="d-flex justify-center align-center" style="height: 200px;">
        <MudProgressCircular Indeterminate="true" Size="Size.Large" Color="Color.Primary" />
        <MudText Typo="Typo.h6" Class="ml-4">Loading settings...</MudText>
    </div>
}
else
{
    <MudGrid>
        <!-- WooCommerce Settings -->
        <MudItem xs="12">
            <MudPaper Class="pa-6 mb-4">
                <MudText Typo="Typo.h5" Class="mb-4">
                    <MudIcon Icon="@Icons.Material.Filled.ShoppingCart" Class="mr-2" />
                    WooCommerce Settings
                </MudText>
                <MudGrid>
                    <MudItem xs="12">
                        <MudTextField @bind-Value="settings.WooCommerce.Url"
                                    Label="Store URL"
                                    Placeholder="https://your-store.com"
                                    Variant="Variant.Outlined"
                                    HelperText="Your WooCommerce store URL" />
                    </MudItem>
                    <MudItem xs="12" md="4">
                        <MudTextField @bind-Value="settings.WooCommerce.Version"
                                    Label="API Version"
                                    Variant="Variant.Outlined"
                                    HelperText="WooCommerce API version" />
                    </MudItem>
                    <MudItem xs="12" md="4">
                        <MudTextField @bind-Value="settings.WooCommerce.ConsumerKey"
                                    Label="Consumer Key"
                                    InputType="InputType.Password"
                                    Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" md="4">
                        <MudTextField @bind-Value="settings.WooCommerce.ConsumerSecret"
                                    Label="Consumer Secret"
                                    InputType="InputType.Password"
                                    Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12">
                        <MudButton StartIcon="@Icons.Material.Filled.CheckCircle"
                                 Color="Color.Secondary"
                                 Variant="Variant.Outlined"
                                 OnClick="@(() => TestConnection("woocommerce"))"
                                 Disabled="isTestingConnection">
                            @if (isTestingConnection && testingService == "woocommerce")
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                                <span class="ml-2">Testing...</span>
                            }
                            else
                            {
                                <span>Test Connection</span>
                            }
                        </MudButton>
                    </MudItem>
                </MudGrid>
            </MudPaper>
        </MudItem>

        <!-- Product Matching Settings -->
        <MudItem xs="12">
            <MudPaper Class="pa-6 mb-4">
                <MudText Typo="Typo.h5" Class="mb-4">
                    <MudIcon Icon="@Icons.Material.Filled.LinkOff" Class="mr-2" />
                    Product Matching Settings
                </MudText>
                <MudGrid>
                    <MudItem xs="12" md="6">
                        <MudSelect @bind-Value="settings.Matching.PrimaryField"
                                 Label="Primary Matching Field"
                                 Variant="Variant.Outlined"
                                 HelperText="Primary field to match products">
                            <MudSelectItem Value="@("sku")">SKU</MudSelectItem>
                            <MudSelectItem Value="@("barcode")">Barcode</MudSelectItem>
                            <MudSelectItem Value="@("code")">Code</MudSelectItem>
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudSelect @bind-Value="settings.Matching.SecondaryField"
                                 Label="Secondary Matching Field"
                                 Variant="Variant.Outlined"
                                 HelperText="Fallback field to match products">
                            <MudSelectItem Value="@("sku")">SKU</MudSelectItem>
                            <MudSelectItem Value="@("barcode")">Barcode</MudSelectItem>
                            <MudSelectItem Value="@("code")">Code</MudSelectItem>
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudSwitch @bind-Value="settings.Matching.CreateMissingProducts"
                                 Label="Create Missing Products"
                                 Color="Color.Primary" />
                        <MudText Typo="Typo.caption" Class="ml-4">Create products that don't exist in WooCommerce</MudText>
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudSwitch @bind-Value="settings.Matching.UpdateExistingProducts"
                                 Label="Update Existing Products"
                                 Color="Color.Primary" />
                        <MudText Typo="Typo.caption" Class="ml-4">Update products that already exist in WooCommerce</MudText>
                    </MudItem>
                </MudGrid>
            </MudPaper>
        </MudItem>

        <!-- Field Mapping Settings -->
        <MudItem xs="12">
            <MudPaper Class="pa-6 mb-4">
                <MudText Typo="Typo.h5" Class="mb-4">
                    <MudIcon Icon="@Icons.Material.Filled.Transform" Class="mr-2" />
                    Field Mapping (SoftOne Go â†’ WooCommerce)
                </MudText>
                <MudGrid>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="settings.FieldMapping.Sku"
                                    Label="SKU Field"
                                    Variant="Variant.Outlined"
                                    HelperText="SoftOne field for product SKU" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="settings.FieldMapping.Name"
                                    Label="Name Field"
                                    Variant="Variant.Outlined"
                                    HelperText="SoftOne field for product name" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="settings.FieldMapping.Price"
                                    Label="Price Field"
                                    Variant="Variant.Outlined"
                                    HelperText="SoftOne field for product price" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="settings.FieldMapping.StockQuantity"
                                    Label="Stock Quantity Field"
                                    Variant="Variant.Outlined"
                                    HelperText="SoftOne field for stock quantity" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="settings.FieldMapping.Category"
                                    Label="Category Field"
                                    Variant="Variant.Outlined"
                                    HelperText="SoftOne field for product category" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="settings.FieldMapping.Unit"
                                    Label="Unit Field"
                                    Variant="Variant.Outlined"
                                    HelperText="SoftOne field for product unit" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="settings.FieldMapping.Vat"
                                    Label="VAT Field"
                                    Variant="Variant.Outlined"
                                    HelperText="SoftOne field for VAT rate" />
                    </MudItem>
                </MudGrid>
            </MudPaper>
        </MudItem>

        <!-- Sync Settings -->
        <MudItem xs="12">
            <MudPaper Class="pa-6 mb-4">
                <MudText Typo="Typo.h5" Class="mb-4">
                    <MudIcon Icon="@Icons.Material.Filled.Sync" Class="mr-2" />
                    Sync Settings
                </MudText>
                <MudGrid>
                    <MudItem xs="12" md="4">
                        <MudNumericField @bind-Value="settings.Sync.IntervalMinutes"
                                       Label="Sync Interval (minutes)"
                                       Variant="Variant.Outlined"
                                       Min="1"
                                       Max="1440"
                                       HelperText="How often to sync automatically" />
                    </MudItem>
                    <MudItem xs="12" md="4">
                        <MudSwitch @bind-Value="settings.Sync.AutoSync"
                                 Label="Auto Sync Enabled"
                                 Color="Color.Primary" />
                    </MudItem>
                    <MudItem xs="12" md="4">
                        <MudSwitch @bind-Value="settings.Sync.EmailNotifications"
                                 Label="Email Notifications"
                                 Color="Color.Primary" />
                    </MudItem>
                </MudGrid>
            </MudPaper>
        </MudItem>

        <!-- Email Settings -->
        <MudItem xs="12">
            <MudPaper Class="pa-6 mb-4">
                <MudText Typo="Typo.h5" Class="mb-4">
                    <MudIcon Icon="@Icons.Material.Filled.Email" Class="mr-2" />
                    Email Settings
                </MudText>
                <MudGrid>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="settings.Email.SmtpHost"
                                    Label="SMTP Host"
                                    Placeholder="smtp.gmail.com"
                                    Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudNumericField @bind-Value="settings.Email.SmtpPort"
                                       Label="SMTP Port"
                                       Variant="Variant.Outlined"
                                       Min="1"
                                       Max="65535" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="settings.Email.Username"
                                    Label="Username"
                                    Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="settings.Email.Password"
                                    Label="Password"
                                    InputType="InputType.Password"
                                    Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="settings.Email.FromEmail"
                                    Label="From Email"
                                    Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudTextField @bind-Value="settings.Email.ToEmail"
                                    Label="To Email"
                                    Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12">
                        <MudButton StartIcon="@Icons.Material.Filled.Email"
                                 Color="Color.Secondary"
                                 Variant="Variant.Outlined"
                                 OnClick="@(() => TestEmail())"
                                 Disabled="isTestingEmail">
                            @if (isTestingEmail)
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                                <span class="ml-2">Sending Test Email...</span>
                            }
                            else
                            {
                                <span>Send Test Email</span>
                            }
                        </MudButton>
                    </MudItem>
                </MudGrid>
            </MudPaper>
        </MudItem>

        <!-- Action Buttons -->
        <MudItem xs="12">
            <MudStack Row="true" Justify="Justify.FlexEnd" Spacing="3">
                <MudButton StartIcon="@Icons.Material.Filled.Save"
                         Color="Color.Primary"
                         Variant="Variant.Filled"
                         OnClick="@(async () => await SaveSettings())"
                         Disabled="isSaving">
                    @if (isSaving)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                        <span class="ml-2">Saving...</span>
                    }
                    else
                    {
                        <span>Save Settings</span>
                    }
                </MudButton>
            </MudStack>
        </MudItem>
    </MudGrid>
}
